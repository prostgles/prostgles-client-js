!function(e,n){if("object"==typeof exports&&"object"==typeof module)module.exports=n();else if("function"==typeof define&&define.amd)define([],n);else{var t=n();for(var r in t)("object"==typeof exports?exports:e)[r]=t[r]}}(this||window,(function(){return function(e){var n={};function t(r){if(n[r])return n[r].exports;var a=n[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,t),a.l=!0,a.exports}return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var a in e)t.d(r,a,function(n){return e[n]}.bind(null,a));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=0)}([function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.prostgles=void 0,n.prostgles=function(e,n){const{socket:t,onReady:r,onDisconnect:a,onReconnect:o}=e,i="_psqlWS_.";let s={},c={},l={},u=!1;function m(e,n){s[e]&&(s[e].handlers=s[e].handlers.filter(e=>e!==n),s[e].handlers.length||(t.emit(e+"unsubscribe",{},(e,n)=>{}),t.removeListener(e,s[e].onCall),delete s[e]))}function f({tableName:e,command:n,param1:r,param2:a},o){return new Promise((s,c)=>{t.emit(i,{tableName:e,command:n,param1:r,param2:a},(e,n)=>{if(e)console.error(e),c(e);else if(n){const{id_fields:e,synced_field:r,channelName:a}=n;t.emit(a,{onSyncRequest:o({},n)},e=>{console.log(e)}),s({id_fields:e,synced_field:r,channelName:a})}})})}function d({tableName:e,command:n,param1:r,param2:a}){return new Promise((o,s)=>{t.emit(i,{tableName:e,command:n,param1:r,param2:a},(e,n)=>{e?(console.error(e),s(e)):n&&o(n.channelName)})})}async function p({tableName:e,command:n,param1:r,param2:a},o){const{onPullRequest:i,onSyncRequest:s,onUpdates:c}=o;function u(e,n){return Object.freeze({unsync:function(){!function(e,n){new Promise((r,a)=>{l[e]&&(l[e].triggers=l[e].triggers.filter(e=>e.onPullRequest!==n.onPullRequest&&e.onSyncRequest!==n.onSyncRequest&&e.onUpdates!==n.onUpdates),l[e].triggers.length||(t.emit(e+"unsync",{},(e,n)=>{e?a(e):r(n)}),t.removeListener(e,l[e].onCall),delete l[e]))})}(e,o)},syncData:function(r,a,o){t.emit(e,{onSyncRequest:{...s({},n),...{data:r}||{},...{deleted:a}||{}}},o?e=>{o(e)}:null)}})}const m=Object.keys(l).find(t=>{let o=l[t];return o.tableName===e&&o.command===n&&JSON.stringify(o.param1||{})===JSON.stringify(r||{})&&JSON.stringify(o.param2||{})===JSON.stringify(a||{})});if(m)return l[m].triggers.push(o),u(m,l[m].syncInfo);{const i=await f({tableName:e,command:n,param1:r,param2:a},s),{channelName:c,synced_field:m,id_fields:p}=i;function d(e,n){e&&l[c]&&l[c].triggers.map(({onUpdates:t,onSyncRequest:r,onPullRequest:a})=>{e.data&&e.data.length?Promise.resolve(t(e,i)).then(()=>{n&&n({ok:!0})}).catch(e=>{n&&n({err:e})}):e.onSyncRequest?Promise.resolve(r(e.onSyncRequest,i)).then(e=>n({onSyncRequest:e})).catch(e=>{n&&n({err:e})}):e.onPullRequest?Promise.resolve(a(e.onPullRequest,i)).then(e=>{n({data:e})}).catch(e=>{n&&n({err:e})}):console.log("unexpected response")})}return l[c]={tableName:e,command:n,param1:r,param2:a,triggers:[o],syncInfo:i,onCall:d},t.on(c,d),u(c,i)}}return new Promise((e,y)=>{a&&t.on("disconnect",a),t.on(i+"schema",({schema:a,methods:y,fullSchema:b,auth:g,rawSQL:O,joinTables:h=[],err:N})=>{if(N)throw N;Object.values(s).map(e=>e.destroy()),s={},l={},Object.values(c).map(e=>{e&&e.destroy&&e.destroy()}),c={},u&&o&&o(t),u=!0;let S=JSON.parse(JSON.stringify(a)),J=JSON.parse(JSON.stringify(y)),j={},w={};g&&(w={...g},["login","logout","register"].map(e=>{g[e]&&(w[e]=function(n){return new Promise((r,a)=>{t.emit(i+e,n,(e,n)=>{e?a(e):r(n)})})})})),J.map(e=>{j[e]=function(...n){return new Promise((r,a)=>{t.emit(i+"method",{method:e,params:n},(e,n)=>{e?a(e):r(n)})})}}),j=Object.freeze(j),O&&(S.sql=function(e,n,r){return new Promise((a,o)=>{t.emit(i+"sql",{query:e,params:n,options:r},(e,n)=>{e?o(e):a(n)})})});const P=["subscribe","subscribeOne"];Object.keys(S).forEach(e=>{Object.keys(S[e]).sort((e,n)=>P.includes(e)-P.includes(n)).forEach(r=>{if(["find","findOne"].includes(r)&&(S[e].getJoinedTables=function(){return(h||[]).filter(n=>Array.isArray(n)&&n.includes(e)).flat().filter(n=>n!==e)}),"sync"===r){if(S[e]._syncInfo={...S[e][r]},n){S[e].getSync=(t,r={})=>new n({name:e,filter:t,db:S,...r});const t=(t={},r={})=>{const a=`${e}.${JSON.stringify(t)}.${JSON.stringify(r)}`;return c[a]||(c[a]=new n({...r,name:e,filter:t,db:S})),c[a]};S[e].sync=(e,n,r)=>t(e,n).sync(r,n),S[e].syncOne=(e,n,r)=>t(e,n).syncOne(e,r,n.handlesOnData)}S[e]._sync=function(n,t,a){return p({tableName:e,command:r,param1:n,param2:t},a)}}else P.includes(r)?S[e][r]=function(n,a,o){return async function(e,{tableName:n,command:r,param1:a,param2:o},i){function c(t){let r={unsubscribe:function(){m(t,i)}};return e[n].update&&(r={...r,update:function(t,r){return e[n].update(a,t,r)}}),e[n].delete&&(r={...r,delete:function(t){return e[n].delete(a,t)}}),Object.freeze(r)}const l=Object.keys(s).find(e=>{let t=s[e];return t.tableName===n&&t.command===r&&JSON.stringify(t.param1||{})===JSON.stringify(a||{})&&JSON.stringify(t.param2||{})===JSON.stringify(o||{})});if(l)return s[l].handlers.push(i),s[l].handlers.includes(i)&&console.warn("Duplicate subscription handler was added for:",s[l]),c(l);{const e=await d({tableName:n,command:r,param1:a,param2:o});let l=function(n,t){s[e].handlers.map(e=>{e(n.data)})};return t.on(e,l),s[e]={tableName:n,command:r,param1:a,param2:o,onCall:l,handlers:[i],destroy:()=>{s[e]&&(Object.values(s[e]).map(n=>{n.handlers.map(n=>m(e,n))}),delete s[e])}},c(e)}}(S,{tableName:e,command:r,param1:n,param2:a},o)}:S[e][r]=function(n,a,o){return new Promise((s,c)=>{t.emit(i,{tableName:e,command:r,param1:n,param2:a,param3:o},(e,n)=>{e?c(e):s(n)})})}})}),s&&Object.keys(s).length&&Object.keys(s).map(async e=>{try{let n=s[e];await d(n),t.on(e,n.onCall)}catch(e){console.error("There was an issue reconnecting olf subscriptions",e)}}),l&&Object.keys(l).length&&Object.keys(l).filter(e=>l[e].triggers&&l[e].triggers.length).map(async e=>{try{let n=l[e];await f(n,n.triggers[0].onSyncRequest),t.on(e,n.onCall)}catch(e){console.error("There was an issue reconnecting olf subscriptions",e)}}),h.flat().map(e=>{function n(n=!0,t,r,a){return{[n?"$leftJoin":"$innerJoin"]:e,filter:t,select:r,...a}}S.innerJoin=S.innerJoin||{},S.leftJoin=S.leftJoin||{},S.innerJoinOne=S.innerJoinOne||{},S.leftJoinOne=S.leftJoinOne||{},S.leftJoin[e]=(e,t,r={})=>n(!0,e,t,r),S.innerJoin[e]=(e,t,r={})=>n(!1,e,t,r),S.leftJoinOne[e]=(e,t,r={})=>n(!0,e,t,{...r,limit:1}),S.innerJoinOne[e]=(e,t,r={})=>n(!1,e,t,{...r,limit:1})});try{r(S,j,b,w)}catch(N){console.error("Prostgles: Error within onReady: \n",N)}e(S)})})}}])}));