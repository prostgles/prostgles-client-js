!function(e,n){if("object"==typeof exports&&"object"==typeof module)module.exports=n();else if("function"==typeof define&&define.amd)define([],n);else{var t=n();for(var r in t)("object"==typeof exports?exports:e)[r]=t[r]}}(this||window,(function(){return function(e){var n={};function t(r){if(n[r])return n[r].exports;var a=n[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,t),a.l=!0,a.exports}return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var a in e)t.d(r,a,function(n){return e[n]}.bind(null,a));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=0)}([function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.prostgles=void 0,n.prostgles=function(e,n){const{socket:t,onReady:r,onDisconnect:a}=e,o="_psqlWS_.";let i={},s={},c={};function l({tableName:e,command:n,param1:r,param2:a},i){return new Promise((s,c)=>{t.emit(o,{tableName:e,command:n,param1:r,param2:a},(e,n)=>{if(e)console.error(e),c(e);else if(n){const{id_fields:e,synced_field:r,channelName:a}=n;t.emit(a,{onSyncRequest:i({},n)},e=>{console.log(e)}),s({id_fields:e,synced_field:r,channelName:a})}})})}function u({tableName:e,command:n,param1:r,param2:a}){return new Promise((i,s)=>{t.emit(o,{tableName:e,command:n,param1:r,param2:a},(e,n)=>{e?(console.error(e),s(e)):n&&i(n.channelName)})})}async function m({tableName:e,command:n,param1:r,param2:a},o){const{onPullRequest:i,onSyncRequest:s,onUpdates:u}=o;function m(e,n){return Object.freeze({unsync:function(){!function(e,n){new Promise((r,a)=>{c[e]&&(c[e].triggers=c[e].triggers.filter(e=>e.onPullRequest!==n.onPullRequest&&e.onSyncRequest!==n.onSyncRequest&&e.onUpdates!==n.onUpdates),c[e].triggers.length||(t.emit(e+"unsync",{},(e,n)=>{e?a(e):r(n)}),t.removeListener(e,c[e].onCall),delete c[e]))})}(e,o)},syncData:function(r,a,o){t.emit(e,{onSyncRequest:{...s({},n),...{data:r}||{},...{deleted:a}||{}}},o?e=>{o(e)}:null)}})}const f=Object.keys(c).find(t=>{let o=c[t];return o.tableName===e&&o.command===n&&JSON.stringify(o.param1||{})===JSON.stringify(r||{})&&JSON.stringify(o.param2||{})===JSON.stringify(a||{})});if(f)return c[f].triggers.push(o),m(f,c[f].syncInfo);{const i=await l({tableName:e,command:n,param1:r,param2:a},s),{channelName:u,synced_field:f,id_fields:p}=i;function d(e,n){e&&c[u]&&c[u].triggers.map(({onUpdates:t,onSyncRequest:r,onPullRequest:a})=>{e.data&&e.data.length?Promise.resolve(t(e.data,i)).then(()=>{n&&n({ok:!0})}).catch(e=>{n&&n({err:e})}):e.onSyncRequest?Promise.resolve(r(e.onSyncRequest,i)).then(e=>n({onSyncRequest:e})).catch(e=>{n&&n({err:e})}):e.onPullRequest?Promise.resolve(a(e.onPullRequest,i)).then(e=>{n({data:e})}).catch(e=>{n&&n({err:e})}):console.log("unexpected response")})}return c[u]={tableName:e,command:n,param1:r,param2:a,triggers:[o],syncInfo:i,onCall:d},t.on(u,d),m(u,i)}}async function f(e,{tableName:n,command:r,param1:a,param2:o},s){function c(r){let o={unsubscribe:function(){!function(e,n){i[e]&&(i[e].handlers=i[e].handlers.filter(e=>e!==n),i[e].handlers.length||(t.emit(e+"unsubscribe",{},(e,n)=>{}),t.removeListener(e,i[e].onCall),delete i[e]))}(r,s)}};return e[n].update&&(o={...o,update:function(t,r){return e[n].update(a,t,r)}}),e[n].delete&&(o={...o,delete:function(t){return e[n].delete(a,t)}}),Object.freeze(o)}const l=Object.keys(i).find(e=>{let t=i[e];return t.tableName===n&&t.command===r&&JSON.stringify(t.param1||{})===JSON.stringify(a||{})&&JSON.stringify(t.param2||{})===JSON.stringify(o||{})});if(l)return i[l].handlers.push(s),i[l].handlers.includes(s)&&console.warn("Duplicate subscription handler was added for:",i[l]),c(l);{const e=await u({tableName:n,command:r,param1:a,param2:o});let l=function(n,t){i[e].handlers.map(e=>{e(n.data)})};return t.on(e,l),i[e]={tableName:n,command:r,param1:a,param2:o,onCall:l,handlers:[s]},c(e)}}return new Promise((e,d)=>{a&&t.on("disconnect",a),t.on(o+"schema",({schema:a,methods:d,fullSchema:p,auth:y,rawSQL:b,joinTables:g=[],err:h})=>{if(h)throw h;let O=JSON.parse(JSON.stringify(a)),N=JSON.parse(JSON.stringify(d)),S={},J={};y&&(J={...y},["login","logout","register"].map(e=>{y[e]&&(J[e]=function(n){return new Promise((r,a)=>{t.emit(o+e,n,(e,n)=>{e?a(e):r(n)})})})})),N.map(e=>{S[e]=function(...n){return new Promise((r,a)=>{t.emit(o+"method",{method:e,params:n},(e,n)=>{e?a(e):r(n)})})}}),S=Object.freeze(S),b&&(O.sql=function(e,n,r){return new Promise((a,i)=>{t.emit(o+"sql",{query:e,params:n,options:r},(e,n)=>{e?i(e):a(n)})})});const w=["subscribe","subscribeOne"];Object.keys(O).forEach(e=>{Object.keys(O[e]).sort((e,n)=>w.includes(e)-w.includes(n)).forEach(r=>{if(["find","findOne"].includes(r)&&(O[e].getJoinedTables=function(){return(g||[]).filter(n=>Array.isArray(n)&&n.includes(e)).flat().filter(n=>n!==e)}),"sync"===r){if(O[e]._syncInfo={...O[e][r]},n){O[e].getSync=(t,r={})=>new n({name:e,filter:t,db:O,...r});const t=(t={},r={})=>{const a=`${e}.${JSON.stringify(t)}.${JSON.stringify(r)}`;return s[a]||(s[a]=new n({name:e,filter:t,db:O,...r})),s[a]};O[e].sync=(e,n={handlesOnData:!0,select:"*"},r)=>t(e,n).sync(r,n),O[e].syncOne=(e,n={handlesOnData:!0},r)=>t(e,n).syncOne(e,r,n.handlesOnData)}O[e]._sync=function(n,t,a){return m({tableName:e,command:r,param1:n,param2:t},a)}}else w.includes(r)?O[e][r]=function(n,t,a){return f(O,{tableName:e,command:r,param1:n,param2:t},a)}:O[e][r]=function(n,a,i){return new Promise((s,c)=>{t.emit(o,{tableName:e,command:r,param1:n,param2:a,param3:i},(e,n)=>{e?c(e):s(n)})})}})}),i&&Object.keys(i).length&&Object.keys(i).map(async e=>{try{let n=i[e];await u(n),t.on(e,n.onCall)}catch(e){console.error("There was an issue reconnecting olf subscriptions",e)}}),c&&Object.keys(c).length&&Object.keys(c).filter(e=>c[e].triggers&&c[e].triggers.length).map(async e=>{try{let n=c[e];await l(n,n.triggers[0].onSyncRequest),t.on(e,n.onCall)}catch(e){console.error("There was an issue reconnecting olf subscriptions",e)}}),g.flat().map(e=>{function n(n=!0,t,r,a){return{[n?"$leftJoin":"$innerJoin"]:e,filter:t,select:r,...a}}O.innerJoin=O.innerJoin||{},O.leftJoin=O.leftJoin||{},O.innerJoinOne=O.innerJoinOne||{},O.leftJoinOne=O.leftJoinOne||{},O.leftJoin[e]=(e,t,r={})=>n(!0,e,t,r),O.innerJoin[e]=(e,t,r={})=>n(!1,e,t,r),O.leftJoinOne[e]=(e,t,r={})=>n(!0,e,t,{...r,limit:1}),O.innerJoinOne[e]=(e,t,r={})=>n(!1,e,t,{...r,limit:1})});try{r(O,S,p,J)}catch(h){console.error("Prostgles: Error within onReady: \n",h)}e(O)})})}}])}));