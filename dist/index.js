!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var s=t();for(var n in s)("object"==typeof exports?exports:e)[n]=s[n]}}(this,(function(){return function(e){var t={};function s(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,s),i.l=!0,i.exports}return s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(n,i,function(t){return e[t]}.bind(null,i));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SyncedTable=t.prostgles=void 0,t.prostgles=function({socket:e,isReady:t=((e,t)=>{}),onDisconnect:s}){const n="_psqlWS_.";var i=[];return new Promise((o,r)=>{s&&e.on("disconnect",s),e.on(n+"schema",({schema:s,methods:r,fullSchema:a})=>{let l=JSON.parse(JSON.stringify(s)),c=JSON.parse(JSON.stringify(r)),h={};c.map(t=>{h[t]=function(s){return new Promise((i,o)=>{e.emit(n+"method",{method:t,params:s},(e,t)=>{e?o(e):i(t)})})}}),h=Object.freeze(h),l.sql&&(l.sql=function(t,s,i){return new Promise((o,r)=>{e.emit(n+"sql",{query:t,params:s,options:i},(e,t)=>{e?r(e):o(t)})})}),Object.keys(l).forEach(t=>{Object.keys(l[t]).forEach(s=>{if("sync"===s){l[t]._syncInfo={...l[t][s]},l[t][s]=function(o,r,a){const{onSyncRequest:l,onPullRequest:c,onUpdates:h}=a;var u,d=this;return e.emit(n,{tableName:t,command:s,param1:o,param2:r,lastUpdated:void 0},(t,s)=>{if(t)throw t;if(s){const{id_fields:t,synced_field:n,channelName:o}=s,r={id_fields:t,synced_field:n};d.sync_info=r,d.channelName=o,d.socket=e,d.syncData=function(t,s,n){e.emit(o,{onSyncRequest:{...l({},r),...{data:t}||{},...{deleted:s}||{}}},n?e=>{n(e)}:null)},e.emit(o,{onSyncRequest:l({},r)},e=>{console.log(e)}),u=function(e,t){e&&(e.data&&e.data.length?Promise.resolve(h(e.data,r)).then(()=>{t&&t({ok:!0})}).catch(e=>{t&&t({err:e})}):e.onSyncRequest?Promise.resolve(l(e.onSyncRequest,r)).then(e=>t({onSyncRequest:e})).catch(e=>{t&&t({err:e})}):e.onPullRequest?Promise.resolve(c(e.onPullRequest,r)).then(e=>{t({data:e})}).catch(e=>{t&&t({err:e})}):console.log("unexpected response"))},i.push({channelName:o,syncHandles:a,socketHandle:u}),e.on(o,u)}}),Object.freeze({unsync:function(){return new Promise((t,s)=>{var n=i.filter(e=>e.channelName===d.channelName);1===n.length?(i=i.filter(e=>e.channelName!==d.channelName),e.emit(d.channelName+"unsync",{},(e,n)=>{e?s(e):t(n)})):n.length>1||console.log("no syncs to unsync from",n),e.removeListener(d.channelName,u)})},syncData:function(e,t){d&&d.syncData&&d.syncData(e,t)}})}}else if("subscribe"===s){l[t][s]=function(o,r,a){var l,c,h=this;return e.emit(n,{tableName:t,command:s,param1:o,param2:r,lastUpdated:void 0},(t,s)=>{if(t)throw t;s&&(l=s.channelName,c=function(t,s){a(t.data),h.channelName=l,h.socket=e},i.push({channelName:l,onChange:a,socketHandle:c}),e.on(l,c))}),Object.freeze({unsubscribe:function(){var t=i.filter(e=>e.channelName===l);1===t.length?(i=i.filter(e=>e.channelName!==l),e.emit(l+"unsubscribe",{},(e,t)=>{})):t.length>1||console.log("no subscriptions to unsubscribe from",t),e.removeListener(l,c)}})}}else l[t][s]=function(i,o,r){return new Promise((a,l)=>{e.emit(n,{tableName:t,command:s,param1:i,param2:o,param3:r},(e,t)=>{e?l(e):a(t)})})}})}),t(l,h),o(l)})})};const n="array",i="localStorage";t.SyncedTable=class{constructor({name:e,filter:t,onChange:s,db:o,pushDebounce:r=100,skipFirstTrigger:a=!1}){if(this.pushDebounce=100,this.skipFirstTrigger=!1,this.items=[],this.storageType=n,this.itemsObj={},this.notifySubscriptions=(e,t,s)=>{this.singleSubscriptions.filter(t=>t.idObj&&this.matchesIdObj(t.idObj,e)&&Object.keys(t.idObj).length<=Object.keys(e).length).map(e=>{e.onChange(t,s)})},this.unsubscribe=e=>{this.singleSubscriptions=this.singleSubscriptions.filter(t=>t.onChange!==e),this.multiSubscriptions=this.multiSubscriptions.filter(t=>t.onChange!==e)},this.unsync=()=>{this.dbSync&&this.dbSync.unsync&&this.dbSync.unsync()},this.delete=e=>{let t=this.getItems();return t=t.filter(t=>!this.matchesIdObj(e,t)),this.setItems(t),this.onDataChanged(null,[e])},this.syncDeleted=async()=>{try{return await Promise.all(this.getDeleted().map(async e=>this.db[this.name].delete(e))),this.setDeleted(null,[]),!0}catch(e){throw e}},this.upsert=async(e,t=!1)=>{let s=this.getItems();t&&this.getDeleted().length&&await this.syncDeleted();let n=[],i=[];e.map(e=>{t||(e[this.synced_field]=Date.now());let o=s.findIndex(t=>!this.id_fields.find(s=>t[s]!==e[s])),r=s[o];r&&r[this.synced_field]<e[this.synced_field]?(s[o]={...e},n.push(e),t&&this.singleSubscriptions.filter(t=>t.idObj&&this.matchesIdObj(t.idObj,e)).map(t=>{t.onChange({...e},{...e})})):r||(s.push({...e}),i.push(e))});const o=[...i,...n];return this.setItems(s),this.onDataChanged(o,null,t),!0},this.onDataChanged=async(e=null,t=null,s=!1)=>new Promise((n,i)=>{const o=this.getItems();this.multiSubscriptions.map(t=>{t.onChange(o,e)}),this.onChange&&this.onChange(o,e),window.onbeforeunload=function(){return"Data may be lost. Are you sure?"},!s&&this.dbSync&&this.dbSync.syncData&&(this.isSendingData&&window.clearTimeout(this.isSendingData),this.isSendingData=setTimeout(async()=>{await this.dbSync.syncData(e,t),n(!0),this.isSendingData=null,window.onbeforeunload=null},this.pushDebounce)),n(!0)}),this.setItems=e=>{this.storageType===i?window.localStorage.setItem(this.name,JSON.stringify(e)):this.storageType===n?this.items=e:console.log("invalid/missing storageType -> "+this.storageType)},this.getItems=e=>{let t=[];if(this.storageType===i){let e=window.localStorage.getItem(this.name);if(e)try{t=JSON.parse(e)}catch(e){console.error(e)}}else this.storageType===n?t=this.items.slice(0):console.log("invalid/missing storageType -> "+this.storageType);if(this.id_fields&&this.synced_field){const e=[this.synced_field,...this.id_fields.sort()];t=t.filter(e=>!this.filter||!Object.keys(this.filter).find(t=>e[t].toString()!==this.filter[t].toString())).sort((t,s)=>e.map(e=>t[e]<s[e]?-1:t[e]>s[e]?1:0).find(e=>e))}return this.items=t,t},this.getBatch=(e,t)=>{let s=this.getItems();e=e||{};const{from_synced:n,to_synced:i,offset:o=0,limit:r=null}=e;let a=s.map(e=>({...e})).filter(e=>(!n||e[this.synced_field]>=n)&&(!i||e[this.synced_field]<=i));return(o||r)&&(a=a.splice(o,r||a.length)),a},this.name=e,this.filter=t,this.onChange=s,!o)throw"db missing";this.db=o;const{id_fields:l,synced_field:c}=o[this.name]._syncInfo;if(!l||!c)throw"id_fields/synced_field missing";this.id_fields=l,this.synced_field=c,this.pushDebounce=r,this.isSendingData=null,this.skipFirstTrigger=a,this.multiSubscriptions=[],this.singleSubscriptions=[];this.dbSync=o[this.name].sync(t,{},{onSyncRequest:(e,t)=>{let s={c_lr:null,c_fr:null,c_count:0},n=this.getBatch(e,t);return n.length&&(s={c_fr:n[0]||null,c_lr:n[n.length-1]||null,c_count:n.length}),s},onPullRequest:async(e,t)=>{this.getDeleted().length&&await this.syncDeleted();return this.getBatch(e,t)},onUpdates:e=>{this.upsert(e,!0)}}),this.onChange&&!this.skipFirstTrigger&&setTimeout(this.onChange,0)}subscribeAll(e){const t={onChange:e};return this.multiSubscriptions.push(t),this.skipFirstTrigger||e(this.getItems()),Object.freeze({unsubscribe:()=>{this.unsubscribe(e)}})}subscribeOne(e,t){if(!e||!t)throw"bad";const s=this.findOne(e);if(!s)throw"no item found";const n={onChange:t,idObj:e,item:s},i={get:()=>this.findOne(e),unsubscribe:()=>{this.unsubscribe(t)},delete:()=>this.delete(e),update:t=>{this.updateOne(e,t)},updateFull:t=>{const s={...t,...e};this.notifySubscriptions(e,s,t),this.upsert([s])}};return this.singleSubscriptions.push(n),setTimeout(()=>t(s,s),0),Object.freeze({...i})}updateOne(e,t){const s={...this.findOne(e),...t,...e};this.notifySubscriptions(e,s,t),this.upsert([s])}findOne(e){this.getItems();let t=-1;return t="function"==typeof e?this.items.findIndex(e):this.items.findIndex(t=>this.matchesIdObj(e,t)),this.items[t]}getIdObj(e){let t={};return this.id_fields.map(s=>{t[s]=e[s]}),t}matchesIdObj(e,t){return Object.keys(e).length&&!Object.keys(e).find(s=>t[s]!==e[s])}deleteAll(){this.getItems().map(this.getIdObj).map(this.delete)}setDeleted(e,t){let s=[];t?s=t:(s=this.getDeleted(),s.push(e)),window.localStorage.setItem(this.name+"_$$psql$$_deleted",s)}getDeleted(){const e=window.localStorage.getItem(this.name+"_$$psql$$_deleted")||"[]";return JSON.parse(e)}}}])}));